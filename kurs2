import tkinter as tk
from tkinter import messagebox
import random
import os
from typing import List, Optional

class RussianBackgammon:
    def __init__(self):
        self.root = tk.Tk()
        self.root.title("–†—É—Å—Å–∫–∏–µ –ù–∞—Ä–¥—ã - –ö—É—Ä—Å–æ–≤–∞—è —Ä–∞–±–æ—Ç–∞")
        self.root.geometry("1000x800+150+50")
        
        # –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        self.current_user = None
        self.board = [0] * 24
        self.current_player = 1  # 1 - –±–µ–ª—ã–µ, -1 - —á–µ—Ä–Ω—ã–µ
        self.dice = []
        self.used_dice = []
        self.selected_checker = None
        self.game_started = False
        
        # –¶–≤–µ—Ç–∞ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
        self.colors = {
            "board": "#DEB887",  # —Ü–≤–µ—Ç –¥–µ—Ä–µ–≤–∞
            "light": "#F5F5DC",   # –±–µ–∂–µ–≤—ã–π
            "dark": "#8B4513",    # –∫–æ—Ä–∏—á–Ω–µ–≤—ã–π
            "white": "#FFFFFF",   # –±–µ–ª—ã–π
            "black": "#000000",   # —á–µ—Ä–Ω—ã–π
            "highlight": "#FF0000", # –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
            "info_bg": "#F0F0F0"  # —Å–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π
        }
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        self.create_gui()
        self.create_auth_form()
        
    def create_gui(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        # –•–æ–ª—Å—Ç –¥–ª—è –¥–æ—Å–∫–∏
        self.canvas = tk.Canvas(self.root, width=900, height=550, 
                               bg=self.colors["board"], highlightthickness=2,
                               highlightbackground=self.colors["dark"])
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å
        self.info_frame = tk.Frame(self.root, bg=self.colors["info_bg"], height=60)
        self.current_player_label = tk.Label(self.info_frame, text="–í–æ–π–¥–∏—Ç–µ –≤ –∏–≥—Ä—É", 
                                           font=("Arial", 16, "bold"), 
                                           bg=self.colors["info_bg"])
        self.status_label = tk.Label(self.info_frame, text="", 
                                   font=("Arial", 12), 
                                   bg=self.colors["info_bg"])
        
        # –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        self.control_frame = tk.Frame(self.root, bg=self.colors["info_bg"])
        self.dice_label = tk.Label(self.control_frame, text="–ö–æ—Å—Ç–∏: ", 
                                 font=("Arial", 14, "bold"),
                                 bg=self.colors["info_bg"])
        
    def create_auth_form(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"""
        self.auth_frame = tk.Frame(self.root, bg=self.colors["light"])
        self.auth_frame.pack(fill=tk.BOTH, expand=True)
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        title_frame = tk.Frame(self.auth_frame, bg=self.colors["dark"])
        title_frame.pack(fill=tk.X, pady=20)
        
        title = tk.Label(title_frame, text="–†–£–°–°–ö–ò–ï –î–õ–ò–ù–ù–´–ï –ù–ê–†–î–´", 
                        font=("Arial", 24, "bold"), 
                        fg="white", bg=self.colors["dark"],
                        pady=15)
        title.pack()
        
        # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
        content_frame = tk.Frame(self.auth_frame, bg=self.colors["light"])
        content_frame.pack(expand=True, pady=50)
        
        login_frame = tk.Frame(content_frame, bg=self.colors["light"])
        login_frame.pack(pady=30)
        
        # –ü–æ–ª—è –≤–≤–æ–¥–∞
        tk.Label(login_frame, text="–õ–æ–≥–∏–Ω:", font=("Arial", 14), 
                bg=self.colors["light"]).grid(row=0, column=0, padx=10, pady=10)
        self.login_entry = tk.Entry(login_frame, font=("Arial", 14), 
                                  width=20, bd=2, relief=tk.GROOVE)
        self.login_entry.grid(row=0, column=1, padx=10, pady=10)
        
        tk.Label(login_frame, text="–ü–∞—Ä–æ–ª—å:", font=("Arial", 14), 
                bg=self.colors["light"]).grid(row=1, column=0, padx=10, pady=10)
        self.password_entry = tk.Entry(login_frame, show="*", font=("Arial", 14), 
                                     width=20, bd=2, relief=tk.GROOVE)
        self.password_entry.grid(row=1, column=1, padx=10, pady=10)
        
        # –ö–Ω–æ–ø–∫–∏
        btn_frame = tk.Frame(content_frame, bg=self.colors["light"])
        btn_frame.pack(pady=30)
        
        login_btn = tk.Button(btn_frame, text="–í–æ–π—Ç–∏", command=self.login, 
                            font=("Arial", 14, "bold"), 
                            bg="#4CAF50", fg="white",
                            width=12, height=1,
                            bd=0, relief=tk.RAISED)
        login_btn.pack(side=tk.LEFT, padx=15)
        
        register_btn = tk.Button(btn_frame, text="–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", 
                               command=self.register,
                               font=("Arial", 14, "bold"), 
                               bg="#2196F3", fg="white",
                               width=18, height=1,
                               bd=0, relief=tk.RAISED)
        register_btn.pack(side=tk.LEFT, padx=15)
        
        self.auth_status_label = tk.Label(content_frame, text="", 
                                        font=("Arial", 12), 
                                        fg="red", bg=self.colors["light"])
        self.auth_status_label.pack(pady=10)
        
        # –ü—Ä–∏–≤—è–∑–∫–∞ Enter
        self.root.bind('<Return>', lambda e: self.login())

    def encrypt(self, text: str, shift: int = 3) -> str:
        """–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞"""
        return ''.join(chr(ord(char) + shift) for char in text)

    def decrypt(self, text: str, shift: int = 3) -> str:
        """–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞"""
        return ''.join(chr(ord(char) - shift) for char in text)

    def register(self):
        """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        login = self.login_entry.get().strip()
        password = self.password_entry.get().strip()
        
        if not login or not password:
            self.auth_status_label.config(text="–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!")
            return
            
        try:
            if os.path.exists("users.txt"):
                with open("users.txt", "r", encoding="utf-8") as f:
                    for line in f:
                        parts = line.strip().split(":")
                        if len(parts) == 2 and self.decrypt(parts[0]) == login:
                            self.auth_status_label.config(text="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!")
                            return
            
            with open("users.txt", "a", encoding="utf-8") as f:
                encrypted_login = self.encrypt(login)
                encrypted_pass = self.encrypt(password)
                f.write(f"{encrypted_login}:{encrypted_pass}\n")
                
            self.auth_status_label.config(text="–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ú–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.", fg="green")
            
        except Exception as e:
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {str(e)}")

    def login(self):
        """–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        login = self.login_entry.get().strip()
        password = self.password_entry.get().strip()
        
        if not login or not password:
            self.auth_status_label.config(text="–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!")
            return
            
        try:
            if not os.path.exists("users.txt"):
                self.auth_status_label.config(text="–§–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω!")
                return
                
            with open("users.txt", "r", encoding="utf-8") as f:
                for line in f:
                    parts = line.strip().split(":")
                    if len(parts) == 2:
                        stored_login = self.decrypt(parts[0])
                        stored_pass = self.decrypt(parts[1])
                        if stored_login == login and stored_pass == password:
                            self.current_user = login
                            self.start_game()
                            return
                
            self.auth_status_label.config(text="–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å!")
            
        except Exception as e:
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {str(e)}")

    def start_game(self):
        """–ù–∞—á–∞–ª–æ –∏–≥—Ä—ã –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"""
        self.game_started = True
        self.setup_board()
        self.show_game_interface()
        self.roll_dice()

    def setup_board(self):
        """–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—á–∞–ª—å–Ω–∞—è —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è —Ä—É—Å—Å–∫–∏—Ö –¥–ª–∏–Ω–Ω—ã—Ö –Ω–∞—Ä–¥"""
        self.board = [0] * 24
        
        # –†—É—Å—Å–∫–∏–µ –¥–ª–∏–Ω–Ω—ã–µ –Ω–∞—Ä–¥—ã - –≤—Å–µ —à–∞—à–∫–∏ —Å–æ–±—Ä–∞–Ω—ã –≤ –æ–¥–Ω–æ–º —É–≥–ª—É
        # –ë–µ–ª—ã–µ (–∏–≥—Ä–æ–∫ 1): 15 —à–∞—à–µ–∫ –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ 1 (–∏–Ω–¥–µ–∫—Å 0)
        self.board[0] = -15
        
        # –ß–µ—Ä–Ω—ã–µ (–∏–≥—Ä–æ–∫ 2): 15 —à–∞—à–µ–∫ –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ 13 (–∏–Ω–¥–µ–∫—Å 12)
        self.board[12] = 15

    def show_game_interface(self):
        """–ü–æ–∫–∞–∑–∞—Ç—å –∏–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"""
        self.auth_frame.pack_forget()
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å
        self.info_frame.pack(fill=tk.X, padx=10, pady=5)
        self.current_player_label.pack(side=tk.LEFT, padx=20, pady=10)
        self.status_label.pack(side=tk.LEFT, padx=20, pady=10)
        
        # –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ
        self.canvas.pack(padx=20, pady=10, fill=tk.BOTH, expand=True)
        self.canvas.bind("<Button-1>", self.on_canvas_click)
        
        # –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        self.control_frame.pack(fill=tk.X, padx=20, pady=10)
        self.dice_label.pack(side=tk.LEFT, padx=20, pady=10)
        
        dice_btn = tk.Button(self.control_frame, text="–ë—Ä–æ—Å–∏—Ç—å –∫–æ—Å—Ç–∏", 
                           command=self.roll_dice,
                           font=("Arial", 12, "bold"), 
                           bg="#FF9800", fg="white",
                           width=12, height=1)
        dice_btn.pack(side=tk.LEFT, padx=10)
        
        new_game_btn = tk.Button(self.control_frame, text="–ù–æ–≤–∞—è –∏–≥—Ä–∞", 
                               command=self.new_game,
                               font=("Arial", 12, "bold"), 
                               bg="#009688", fg="white",
                               width=12, height=1)
        new_game_btn.pack(side=tk.LEFT, padx=10)
        
        self.update_status()
        self.draw_board()

    def draw_board(self):
        """–û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫—Ä–∞—Å–∏–≤–æ–≥–æ –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è"""
        self.canvas.delete("all")
        
        # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω –¥–æ—Å–∫–∏
        self.canvas.create_rectangle(50, 50, 850, 500, 
                                   fill=self.colors["board"], 
                                   outline=self.colors["dark"], width=4)
        
        # –†–∏—Å—É–µ–º 24 —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ (–ø—É–Ω–∫—Ç–∞) - –±–æ–ª–µ–µ –∫—Ä–∞—Å–∏–≤–æ
        for i in range(12):
            # –í–µ—Ä—Ö–Ω–∏–π —Ä—è–¥ (–ø—É–Ω–∫—Ç—ã 12-1)
            x1 = 100 + i * 60
            x2 = x1 + 30
            x3 = x1 + 60
            
            # –ß–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ –≤–∏–¥–∞ –Ω–∞—Ä–¥
            color = self.colors["light"] if i % 2 == 0 else self.colors["dark"]
            
            # –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ –≤–µ—Ä—Ö–Ω–µ–≥–æ —Ä—è–¥–∞
            points_top = [x1, 50, x2, 250, x3, 50]
            self.canvas.create_polygon(points_top, fill=color, 
                                     outline=self.colors["dark"], width=2)
            
            # –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ –Ω–∏–∂–Ω–µ–≥–æ —Ä—è–¥–∞
            points_bottom = [x1, 500, x2, 300, x3, 500]
            self.canvas.create_polygon(points_bottom, fill=color, 
                                     outline=self.colors["dark"], width=2)
        
        # –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è (–±–∞—Ä)
        self.canvas.create_rectangle(50, 250, 850, 300, 
                                   fill=self.colors["dark"], 
                                   outline=self.colors["dark"])
        
        # –†–∏—Å—É–µ–º —à–∞—à–∫–∏
        self.draw_checkers()
        
        # –ü–æ–¥–ø–∏—Å–∏ –ø—É–Ω–∫—Ç–æ–≤
        for i in range(12):
            # –í–µ—Ä—Ö–Ω–∏–π —Ä—è–¥ (12->1)
            self.canvas.create_text(130 + i * 60, 270, text=str(12-i), 
                                  font=("Arial", 12, "bold"), fill="white")
            # –ù–∏–∂–Ω–∏–π —Ä—è–¥ (13->24)
            self.canvas.create_text(130 + i * 60, 280, text=str(13+i), 
                                  font=("Arial", 12, "bold"), fill="white")

    def draw_checkers(self):
        """–û—Ç—Ä–∏—Å–æ–≤–∫–∞ —à–∞—à–µ–∫ –Ω–∞ –¥–æ—Å–∫–µ"""
        for i in range(24):
            count = abs(self.board[i])
            player = -1 if self.board[i] < 0 else 1
            
            if count > 0:
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
                if i < 12:  # –í–µ—Ä—Ö–Ω—è—è –ø–æ–ª–æ–≤–∏–Ω–∞ –¥–æ—Å–∫–∏
                    x = 130 + i * 60
                    base_y = 70
                    direction = 1  # –≤–Ω–∏–∑
                else:  # –ù–∏–∂–Ω—è—è –ø–æ–ª–æ–≤–∏–Ω–∞ –¥–æ—Å–∫–∏
                    x = 130 + (23 - i) * 60
                    base_y = 480
                    direction = -1  # –≤–≤–µ—Ä—Ö
                
                # –†–∏—Å—É–µ–º —à–∞—à–∫–∏ —Å—Ç–æ–ª–±–∏–∫–æ–º (–º–∞–∫—Å–∏–º—É–º 8 –≤ —Å—Ç–æ–ª–±—Ü–µ)
                for j in range(min(count, 8)):
                    y = base_y + j * 25 * direction
                    
                    color = self.colors["white"] if player == 1 else self.colors["black"]
                    outline = self.colors["black"] if player == 1 else self.colors["white"]
                    
                    # –†–∏—Å—É–µ–º —à–∞—à–∫—É —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–º —ç—Ñ—Ñ–µ–∫—Ç–æ–º
                    self.canvas.create_oval(x-20, y-20, x+20, y+20, 
                                          fill=color, outline=outline, width=2)
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –±–ª–∏–∫ –¥–ª—è –æ–±—ä–µ–º–∞
                    if player == 1:  # –±–µ–ª—ã–µ —à–∞—à–∫–∏
                        self.canvas.create_oval(x-15, y-15, x-5, y-5, 
                                              fill="#F0F0F0", outline="")
                
                # –ï—Å–ª–∏ —à–∞—à–µ–∫ –±–æ–ª—å—à–µ 8, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                if count > 8:
                    self.canvas.create_text(x, base_y + 8 * 25 * direction, 
                                          text=str(count), 
                                          font=("Arial", 10, "bold"),
                                          fill="red" if player == 1 else "yellow")

    def roll_dice(self):
        """–ë—Ä–æ—Å–æ–∫ –∏–≥—Ä–∞–ª—å–Ω—ã—Ö –∫–æ—Å—Ç–µ–π"""
        if not self.game_started:
            return
            
        self.dice = [random.randint(1, 6), random.randint(1, 6)]
        self.used_dice = []
        
        # –ï—Å–ª–∏ –≤—ã–ø–∞–ª –¥—É–±–ª—å, –ø–æ–ª—É—á–∞–µ–º 4 —Ö–æ–¥–∞
        if self.dice[0] == self.dice[1]:
            self.dice = self.dice * 2
            
        self.update_status()
        self.draw_board()

    def on_canvas_click(self, event):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –¥–æ—Å–∫–µ"""
        if not self.dice:
            return
            
        pos = self.get_position_from_click(event.x, event.y)
        if pos is not None:
            self.handle_checker_click(pos)

    def get_position_from_click(self, x: int, y: int) -> Optional[int]:
        """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –ø—É–Ω–∫—Ç–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º –∫–ª–∏–∫–∞"""
        if 50 <= y <= 250:  # –í–µ—Ä—Ö–Ω–∏–π —Ä—è–¥
            for i in range(12):
                if 100 + i * 60 <= x <= 160 + i * 60:
                    return i
        elif 300 <= y <= 500:  # –ù–∏–∂–Ω–∏–π —Ä—è–¥
            for i in range(12):
                if 100 + i * 60 <= x <= 160 + i * 60:
                    return 23 - i
        return None

    def handle_checker_click(self, pos: int):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —à–∞—à–∫–µ"""
        if self.selected_checker is None:
            # –í—ã–±–æ—Ä —à–∞—à–∫–∏ –¥–ª—è —Ö–æ–¥–∞
            if self.board[pos] * self.current_player > 0:
                self.selected_checker = pos
                self.highlight_position(pos)
                self.status_label.config(text="–í—ã–±–µ—Ä–∏—Ç–µ –∫—É–¥–∞ —Ö–æ–¥–∏—Ç—å")
        else:
            # –ü–æ–ø—ã—Ç–∫–∞ —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥
            if self.is_valid_move(self.selected_checker, pos):
                self.make_move(self.selected_checker, pos)
                self.selected_checker = None
                self.check_game_end()
            else:
                self.selected_checker = None
                self.status_label.config(text="–ù–µ–≤–µ—Ä–Ω—ã–π —Ö–æ–¥!")
            self.draw_board()

    def highlight_position(self, pos: int):
        """–ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏"""
        self.draw_board()
        if pos < 12:
            x = 130 + pos * 60
            y = 70
        else:
            x = 130 + (23 - pos) * 60
            y = 480
            
        # –†–∏—Å—É–µ–º –∫—Ä–∞—Å–Ω—É—é –æ–±–≤–æ–¥–∫—É –≤–æ–∫—Ä—É–≥ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
        self.canvas.create_oval(x-25, y-25, x+25, y+25, 
                              outline=self.colors["highlight"], width=3)

    def is_valid_move(self, from_pos: int, to_pos: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ö–æ–¥–∞ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º —Ä—É—Å—Å–∫–∏—Ö –Ω–∞—Ä–¥"""
        if not self.dice:
            return False
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å —à–∞—à–∫–∏
        if self.board[from_pos] * self.current_player <= 0:
            return False
            
        # –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
        if self.current_player == 1:  # –ë–µ–ª—ã–µ –¥–≤–∏–∂—É—Ç—Å—è –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –∏–Ω–¥–µ–∫—Å–æ–≤
            distance = (to_pos - from_pos) % 24
            if distance <= 0:
                distance += 24
        else:  # –ß–µ—Ä–Ω—ã–µ –¥–≤–∏–∂—É—Ç—Å—è –ø–æ —É–±—ã–≤–∞–Ω–∏—é –∏–Ω–¥–µ–∫—Å–æ–≤  
            distance = (from_pos - to_pos) % 24
            if distance <= 0:
                distance += 24
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ö–æ–¥–∞ –ø–æ –∫–æ—Å—Ç—è–º
        if distance not in self.dice and distance not in self.used_dice:
            return False
            
        # –í —Ä—É—Å—Å–∫–∏—Ö –Ω–∞—Ä–¥–∞—Ö –º–æ–∂–Ω–æ —Ö–æ–¥–∏—Ç—å –Ω–∞ –ª—é–±–æ–π –ø—É–Ω–∫—Ç, –∫—Ä–æ–º–µ —Ç–µ—Ö, –≥–¥–µ —Å—Ç–æ–∏—Ç 2+ —à–∞—à–µ–∫ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
        if self.board[to_pos] * self.current_player < -1:
            return False
            
        return True

    def make_move(self, from_pos: int, to_pos: int):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ö–æ–¥–∞"""
        # –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
        if self.current_player == 1:
            distance = (to_pos - from_pos) % 24
            if distance <= 0:
                distance += 24
        else:
            distance = (from_pos - to_pos) % 24
            if distance <= 0:
                distance += 24
        
        # –£–±–∏—Ä–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—É—é –∫–æ—Å—Ç—å
        if distance in self.dice:
            self.dice.remove(distance)
            self.used_dice.append(distance)
        else:
            self.used_dice.remove(distance)
        
        # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –æ–¥–Ω—É —à–∞—à–∫—É
        if self.board[from_pos] > 0:
            self.board[from_pos] -= 1
        else:
            self.board[from_pos] += 1
            
        # –ï—Å–ª–∏ –Ω–∞ –ø—É–Ω–∫—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç–æ–∏—Ç –æ–¥–Ω–∞ —à–∞—à–∫–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ - —Å–±–∏–≤–∞–µ–º –µ–µ
        if self.board[to_pos] * self.current_player == -1:
            # –ù–∞—Ö–æ–¥–∏–º —Å—Ç–∞—Ä—Ç–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è —Å–±–∏—Ç–æ–π —à–∞—à–∫–∏
            if self.current_player == 1:  # –°–±–∏–ª–∏ —á–µ—Ä–Ω—É—é —à–∞—à–∫—É
                self.board[12] += 1  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –¥–æ–º —á–µ—Ä–Ω—ã—Ö
            else:  # –°–±–∏–ª–∏ –±–µ–ª—É—é —à–∞—à–∫—É
                self.board[0] -= 1  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –¥–æ–º –±–µ–ª—ã—Ö
        else:
            # –û–±—ã—á–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
            if self.board[to_pos] >= 0:
                self.board[to_pos] += 1
            else:
                self.board[to_pos] -= 1
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ —Ö–æ–¥–∞
        if not self.dice:
            self.current_player *= -1
            self.roll_dice()
        
        self.update_status()

    def update_status(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"""
        player_text = "–ë–ï–õ–´–ï" if self.current_player == 1 else "–ß–ï–†–ù–´–ï"
        user_text = f"–ò–≥—Ä–æ–∫: {self.current_user}" if self.current_player == 1 else "–ò–≥—Ä–æ–∫ 2"
        
        self.current_player_label.config(text=f"{user_text} | –•–û–î: {player_text}")
        
        dice_text = f"üé≤ –ö–æ—Å—Ç–∏: {self.dice}"
        if self.used_dice:
            dice_text += f" | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {self.used_dice}"
        self.dice_label.config(text=dice_text)
        
        if not self.dice:
            self.status_label.config(text="–ë—Ä–æ—Å—å—Ç–µ –∫–æ—Å—Ç–∏!")
        elif self.selected_checker is None:
            self.status_label.config(text="–í—ã–±–µ—Ä–∏—Ç–µ —à–∞—à–∫—É –¥–ª—è —Ö–æ–¥–∞")

    def check_game_end(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã"""
        # –ò–≥—Ä–æ–∫ –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ –≤—Å–µ –µ–≥–æ —à–∞—à–∫–∏ –≤—ã–≤–µ–¥–µ–Ω—ã —Å –¥–æ—Å–∫–∏
        white_win = all(self.board[i] >= 0 for i in range(24))
        black_win = all(self.board[i] <= 0 for i in range(24))
        
        if white_win:
            messagebox.showinfo("–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞", "–ë–µ–ª—ã–µ –≤—ã–∏–≥—Ä–∞–ª–∏!")
            self.new_game()
        elif black_win:
            messagebox.showinfo("–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞", "–ß–µ—Ä–Ω—ã–µ –≤—ã–∏–≥—Ä–∞–ª–∏!")
            self.new_game()

    def new_game(self):
        """–ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–π –∏–≥—Ä—ã"""
        self.setup_board()
        self.current_player = 1
        self.selected_checker = None
        self.dice = []
        self.used_dice = []
        self.roll_dice()
        self.draw_board()

    def run(self):
        """–ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
        self.root.mainloop()

# –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã
if __name__ == "__main__":
    game = RussianBackgammon()
    game.run()
